cmake_minimum_required(VERSION 3.16)

project(nekoray_minimal VERSION 1.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# 查找 Qt5 组件
find_package(Qt5 REQUIRED COMPONENTS Core Network)

# 最小核心源文件 (只包含能编译通过的)
set(MINIMAL_CORE_SOURCES
    # 核心服务层 (已修复的简化版本)
    nekoray/core/NekoService_Fixed.cpp
    nekoray/core/CoreManager_Fixed.cpp
    nekoray/core/TunManager_Fixed.cpp
    nekoray/core/ConfigManager.cpp
    nekoray/core/SafetyUtils.cpp
    
    # 第三方库 (只包含需要的)
    nekoray/3rdparty/base64.cpp
)

# CLI 版本 (最小版本)
add_executable(nekoray-cli-minimal
    ${MINIMAL_CORE_SOURCES}
    nekoray/cli/main_cli.cpp
)

# Web 版本 (最小版本)
add_executable(nekoray-web-minimal
    ${MINIMAL_CORE_SOURCES}
    nekoray/web/SimpleWebServer.cpp
    nekoray/web/main_web.cpp
)

# 链接库
target_link_libraries(nekoray-cli-minimal Qt5::Core Qt5::Network)
target_link_libraries(nekoray-web-minimal Qt5::Core Qt5::Network)

# 包含目录
target_include_directories(nekoray-cli-minimal PRIVATE 
    nekoray 
    nekoray/3rdparty
    ${CMAKE_CURRENT_SOURCE_DIR}
)
target_include_directories(nekoray-web-minimal PRIVATE 
    nekoray 
    nekoray/3rdparty
    ${CMAKE_CURRENT_SOURCE_DIR}
)

# 编译属性
set_target_properties(nekoray-cli-minimal PROPERTIES
    CXX_STANDARD 17
    CXX_STANDARD_REQUIRED ON
    AUTOMOC ON
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
)

set_target_properties(nekoray-web-minimal PROPERTIES
    CXX_STANDARD 17
    CXX_STANDARD_REQUIRED ON
    AUTOMOC ON
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
)

# 编译定义
target_compile_definitions(nekoray-cli-minimal PRIVATE
    NKR_MINIMAL=1
    NKR_CLI=1
)

target_compile_definitions(nekoray-web-minimal PRIVATE
    NKR_MINIMAL=1
    NKR_WEB=1
)

# 安装规则
install(TARGETS nekoray-cli-minimal nekoray-web-minimal
    RUNTIME DESTINATION bin
    COMPONENT Runtime
)

message(STATUS "Building Minimal Working NekoRay")
message(STATUS "Source files: ${MINIMAL_CORE_SOURCES}")
message(STATUS "Qt5 Core: ${Qt5Core_VERSION}")
message(STATUS "Qt5 Network: ${Qt5Network_VERSION}")

# 这是最小可工作版本，提供基础框架
# 之后可以逐步添加更多功能