#!/bin/bash

# NekoRay Daemon Startup Script
# This script helps you start the NekoRay daemon with common configurations

DAEMON_BINARY="@CMAKE_INSTALL_PREFIX@/bin/nekoray-daemon"
DEFAULT_CONFIG_DIR="$HOME/.config/nekoray"
DEFAULT_WEB_PORT=8080
DEFAULT_BIND_ADDR="127.0.0.1"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

show_help() {
    echo "NekoRay Daemon Startup Script"
    echo
    echo "Usage: $0 [OPTIONS]"
    echo
    echo "Options:"
    echo "  -c, --config DIR      Configuration directory (default: $DEFAULT_CONFIG_DIR)"
    echo "  -p, --port PORT       Web API port (default: $DEFAULT_WEB_PORT)"
    echo "  -b, --bind ADDR       Bind address (default: $DEFAULT_BIND_ADDR)"
    echo "  -a, --auto-start ID   Auto-start with profile ID"
    echo "  -t, --tun             Enable TUN mode"
    echo "  -v, --verbose         Verbose logging"
    echo "  -d, --daemon          Run as background daemon"
    echo "  -h, --help            Show this help"
    echo
    echo "Examples:"
    echo "  $0                                    # Start with defaults"
    echo "  $0 -p 8080 -v                       # Start with verbose logging on port 8080"
    echo "  $0 -a 1 -t -d                       # Start profile 1 with TUN mode in background"
    echo "  $0 --config /etc/nekoray --port 80  # Start with custom config and port"
}

check_prerequisites() {
    if [ ! -f "$DAEMON_BINARY" ]; then
        echo -e "${RED}Error: NekoRay daemon binary not found at $DAEMON_BINARY${NC}"
        echo "Please install NekoRay first or check the installation path."
        exit 1
    fi
    
    if [ ! -x "$DAEMON_BINARY" ]; then
        echo -e "${RED}Error: NekoRay daemon binary is not executable${NC}"
        exit 1
    fi
}

check_port() {
    local port=$1
    if netstat -tuln 2>/dev/null | grep -q ":$port "; then
        echo -e "${YELLOW}Warning: Port $port is already in use${NC}"
        read -p "Continue anyway? [y/N]: " response
        if [[ ! "$response" =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
}

setup_config_dir() {
    local config_dir=$1
    if [ ! -d "$config_dir" ]; then
        echo -e "${YELLOW}Creating configuration directory: $config_dir${NC}"
        mkdir -p "$config_dir" || {
            echo -e "${RED}Error: Failed to create configuration directory${NC}"
            exit 1
        }
    fi
}

check_tun_permissions() {
    if [ "$ENABLE_TUN" = "true" ]; then
        if [ "$EUID" -ne 0 ]; then
            echo -e "${YELLOW}Warning: TUN mode requires root privileges${NC}"
            echo "You may need to run with sudo or configure proper capabilities"
        fi
    fi
}

# Default values
CONFIG_DIR="$DEFAULT_CONFIG_DIR"
WEB_PORT="$DEFAULT_WEB_PORT"
BIND_ADDR="$DEFAULT_BIND_ADDR"
AUTO_START=""
ENABLE_TUN="false"
VERBOSE="false"
BACKGROUND="false"

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -c|--config)
            CONFIG_DIR="$2"
            shift 2
            ;;
        -p|--port)
            WEB_PORT="$2"
            shift 2
            ;;
        -b|--bind)
            BIND_ADDR="$2"
            shift 2
            ;;
        -a|--auto-start)
            AUTO_START="$2"
            shift 2
            ;;
        -t|--tun)
            ENABLE_TUN="true"
            shift
            ;;
        -v|--verbose)
            VERBOSE="true"
            shift
            ;;
        -d|--daemon)
            BACKGROUND="true"
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            show_help
            exit 1
            ;;
    esac
done

# Run checks
check_prerequisites
check_port "$WEB_PORT"
setup_config_dir "$CONFIG_DIR"
check_tun_permissions

# Build command line arguments
ARGS=()
ARGS+=("--config" "$CONFIG_DIR")
ARGS+=("--port" "$WEB_PORT")
ARGS+=("--bind" "$BIND_ADDR")

if [ "$VERBOSE" = "true" ]; then
    ARGS+=("--verbose")
fi

if [ -n "$AUTO_START" ]; then
    ARGS+=("--auto-start" "$AUTO_START")
fi

if [ "$ENABLE_TUN" = "true" ]; then
    ARGS+=("--tun")
fi

# Show startup information
echo -e "${GREEN}Starting NekoRay Daemon${NC}"
echo "Configuration: $CONFIG_DIR"
echo "Web Interface: http://$BIND_ADDR:$WEB_PORT"
if [ -n "$AUTO_START" ]; then
    echo "Auto-start Profile: $AUTO_START"
fi
if [ "$ENABLE_TUN" = "true" ]; then
    echo "TUN Mode: Enabled"
fi
echo

# Start the daemon
if [ "$BACKGROUND" = "true" ]; then
    echo "Starting in background mode..."
    nohup "$DAEMON_BINARY" "${ARGS[@]}" > /dev/null 2>&1 &
    DAEMON_PID=$!
    echo "Daemon started with PID: $DAEMON_PID"
    echo "Use 'kill $DAEMON_PID' to stop the daemon"
else
    echo "Starting in foreground mode (Press Ctrl+C to stop)..."
    exec "$DAEMON_BINARY" "${ARGS[@]}"
fi