cmake_minimum_required(VERSION 3.16)

project(nekoray_headless VERSION 1.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Find Qt components (Core and Network for headless, HttpServer for web API)
find_package(Qt6 REQUIRED COMPONENTS Core Network HttpServer)

# Include directories from original project
include_directories(${CMAKE_CURRENT_SOURCE_DIR})

# Find required libraries (same as original project)
if (NOT NKR_LIBS)
    if (NKR_PACKAGE)
        list(APPEND NKR_LIBS ${CMAKE_SOURCE_DIR}/libs/deps/package)
    else ()
        list(APPEND NKR_LIBS ${CMAKE_SOURCE_DIR}/libs/deps/built)
    endif ()
endif ()

if (NOT NKR_DISABLE_LIBS)
    list(APPEND CMAKE_PREFIX_PATH ${NKR_LIBS})
endif ()

# External dependencies (same as original)
find_package(Threads)

if (NOT NKR_NO_GRPC)
    find_package(Protobuf CONFIG REQUIRED)
    find_package(gRPC CONFIG REQUIRED)
    include("cmake/myproto.cmake")
    list(APPEND NKR_EXTERNAL_TARGETS myproto)
endif ()

if (NOT NKR_NO_YAML)
    find_package(yaml-cpp CONFIG REQUIRED)
    list(APPEND NKR_EXTERNAL_TARGETS yaml-cpp)
endif ()

# Core service library sources
set(CORE_SOURCES
    # Core headless service
    core/NekoService.hpp
    core/NekoService.cpp
    core/CoreManager.cpp
    core/TunManager.cpp
    core/ConfigManager.cpp

    # Reuse existing backend code (without GUI dependencies)
    main/NekoGui.cpp
    main/NekoGui_Utils.cpp
    main/HTTPRequestHelper.cpp

    # Database and config
    db/Database.cpp
    db/traffic/TrafficLooper.cpp
    db/ProfileFilter.cpp
    db/ConfigBuilder.cpp

    # Format handlers
    fmt/AbstractBean.cpp
    fmt/Bean2CoreObj_box.cpp
    fmt/Bean2External.cpp
    fmt/Bean2Link.cpp
    fmt/Link2Bean.cpp

    # Subscription
    sub/GroupUpdater.cpp

    # System utilities (non-GUI parts)
    sys/ExternalProcess.cpp
    sys/AutoRun.cpp

    # RPC
    rpc/gRPC.cpp

    # 3rd party utilities (non-GUI)
    3rdparty/base64.cpp
    3rdparty/qrcodegen.cpp
    3rdparty/qv2ray/v3/components/GeositeReader/GeositeReader.cpp
    3rdparty/qv2ray/v3/components/GeositeReader/picoproto.cpp
)

# Web API sources
set(WEB_SOURCES
    web/WebApiServer.hpp
    web/WebApiServer.cpp
)

# Create core service library
add_library(nekoray_core_service STATIC ${CORE_SOURCES})
target_link_libraries(nekoray_core_service 
    Qt6::Core Qt6::Network
    Threads::Threads
    ${NKR_EXTERNAL_TARGETS}
)

# Define compile definitions for headless mode
target_compile_definitions(nekoray_core_service PRIVATE
    NKR_HEADLESS_MODE
)

# CLI executable
add_executable(nekoray-cli
    cli/main_cli.cpp
    ${CORE_SOURCES}
)

target_link_libraries(nekoray-cli
    Qt6::Core Qt6::Network
    Threads::Threads
    ${NKR_EXTERNAL_TARGETS}
)

target_compile_definitions(nekoray-cli PRIVATE
    NKR_HEADLESS_MODE
)

# Daemon executable with web interface
add_executable(nekoray-daemon
    daemon/main_daemon.cpp
    ${CORE_SOURCES}
    ${WEB_SOURCES}
)

target_link_libraries(nekoray-daemon
    Qt6::Core Qt6::Network Qt6::HttpServer
    Threads::Threads
    ${NKR_EXTERNAL_TARGETS}
)

target_compile_definitions(nekoray-daemon PRIVATE
    NKR_HEADLESS_MODE
)

# Set target properties
set_target_properties(nekoray-cli nekoray-daemon PROPERTIES
    CXX_STANDARD 17
    CXX_STANDARD_REQUIRED ON
)

# Installation
install(TARGETS nekoray-cli nekoray-daemon
    RUNTIME DESTINATION bin
)

# Copy necessary resources
install(DIRECTORY res/vpn/
    DESTINATION share/nekoray/vpn
    FILES_MATCHING PATTERN "*.json" PATTERN "*.sh"
)

# Create systemd service file for Linux
if (UNIX AND NOT APPLE)
    configure_file(
        "${CMAKE_CURRENT_SOURCE_DIR}/scripts/nekoray-daemon.service.in"
        "${CMAKE_CURRENT_BINARY_DIR}/nekoray-daemon.service"
        @ONLY
    )
    
    install(FILES "${CMAKE_CURRENT_BINARY_DIR}/nekoray-daemon.service"
        DESTINATION /etc/systemd/system
        PERMISSIONS OWNER_READ OWNER_WRITE GROUP_READ WORLD_READ
    )
endif()

# Create startup scripts
configure_file(
    "${CMAKE_CURRENT_SOURCE_DIR}/scripts/nekoray-daemon.sh.in"
    "${CMAKE_CURRENT_BINARY_DIR}/nekoray-daemon.sh"
    @ONLY
)

install(FILES "${CMAKE_CURRENT_BINARY_DIR}/nekoray-daemon.sh"
    DESTINATION bin
    PERMISSIONS OWNER_READ OWNER_WRITE OWNER_EXECUTE GROUP_READ GROUP_EXECUTE WORLD_READ WORLD_EXECUTE
)